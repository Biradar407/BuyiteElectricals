<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M/s. Buyite Electricals - Expenditure Tracker</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#e9ebed; color:#222; }
header { background: linear-gradient(135deg,#f7b76b,#f6a13b); color:#fff; padding:20px; text-align:center; font-size:1.8em; font-weight:bold; box-shadow:0 3px 6px rgba(0,0,0,0.15); border-bottom-left-radius:10px; border-bottom-right-radius:10px;}
nav { display:flex; justify-content:space-evenly; align-items:center; background:#cfd3d8; box-shadow:0 2px 5px rgba(0,0,0,0.05); padding:10px; flex-wrap:nowrap; overflow:hidden;}
nav button { background:#cfd3d8; border:1px solid #888; color:#222; cursor:pointer; border-radius:6px; font-weight:bold; transition:all 0.3s ease; width:160px; height:50px; display:flex; justify-content:center; align-items:center; text-align:center; white-space:normal; padding:0 10px;}
nav button:hover { background:#b0b4b9; transform:scale(1.03);}
.panel { display:none; padding:20px; max-width:950px; margin:auto; height:calc(100vh - 150px); overflow-y:auto;}
.active { display:block; }
.card { background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.05); margin-bottom:25px; }
h2,h3,h4 { margin-top:0; color:#333; }
input,select,button { padding:10px; margin:6px 0; border:1px solid #ccc; border-radius:6px; width:100%; font-size:1em; box-sizing:border-box; }
button.action { background:#7f8a8f; color:white; border:none; width:auto; cursor:pointer; font-weight:bold; transition:0.3s; padding:10px 18px; margin-top:10px; border-radius:6px;}
button.action:hover { background:#666f74; transform:scale(1.03);}
table { width:100%; border-collapse:collapse; margin-top:15px; }
th,td { border:1px solid #ddd; padding:10px; text-align:left; font-size:0.95em; }
th { background:#55595c; color:white; text-transform:uppercase; letter-spacing:0.5px; }
tr:nth-child(even){ background:#e6e8eb; }
.scrollable-table { max-height:400px; overflow-y:auto; }
.summary { background:#dfe2e5; padding:15px; border-radius:8px; margin-top:15px; font-weight:bold; }
::-webkit-scrollbar{ width:8px;}
::-webkit-scrollbar-track{ background:#f1f1f1; border-radius:10px;}
::-webkit-scrollbar-thumb{ background:#7f8a8f; border-radius:10px;}
::-webkit-scrollbar-thumb:hover{ background:#666f74;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<header>M/s. Buyite Electricals - Expenditure Tracker</header>

<nav>
<button onclick="showPanel('personal')">Personal Expenditure</button>
<button onclick="showPanel('sites')">Site Management</button>
<button onclick="showPanel('analysis')">Data Analysis</button>
</nav>

<!-- Personal Expenditure Panel -->
<div id="personal" class="panel active">
<div class="card">
<h2>Personal Expenditure</h2>
<label>Description:</label><input type="text" id="personalDesc">
<label>Amount:</label><input type="number" id="personalAmt">
<label>Date:</label><input type="date" id="personalDate">
<label>Payment Type:</label>
<select id="personalPayment"><option>Cash</option><option>IMPS</option><option>RTGS</option><option>PhonePe</option></select>
<button class="action" onclick="addPersonalExpense()">Add Expense</button>
<div class="scrollable-table"><table id="personalTable"><tr><th>Category</th><th>Description</th><th>Amount</th><th>Date</th><th>Payment</th></tr></table></div>
</div>
</div>

<!-- Site Management Panel -->
<div id="sites" class="panel">
<div class="card">
<h2>Site Management</h2>
<label>Add New Site:</label>
<input type="text" id="siteName" placeholder="Enter new site name">
<button class="action" onclick="addSite()">Add Site</button>
<label>Or Select Existing Site:</label>
<select id="siteSelectManage" onchange="populateSiteFields()"><option value="">--Select Site--</option></select>
<div id="siteFields" style="margin-top:15px; display:none;">
<label>Category:</label>
<select id="cat-selected"><option value="Labour">Labour Payment</option><option value="Travel">Travel</option><option value="Material">Material</option><option value="Office">Office Expenses</option><option value="Misc">Miscellaneous</option></select>
<label>Description:</label><input type="text" id="desc-selected">
<label>Amount:</label><input type="number" id="amt-selected">
<label>Date:</label><input type="date" id="date-selected">
<label>Payment Type:</label><select id="pay-selected"><option>Cash</option><option>IMPS</option><option>RTGS</option><option>PhonePe</option></select>
<button class="action" onclick="addSiteExpenseFromSelect()">Add Expense</button>
<div class="scrollable-table"><table id="table-selected"><tr><th>Category</th><th>Description</th><th>Amount</th><th>Date</th><th>Payment</th></tr></table></div>
</div>
<div id="siteList"></div>
</div>
</div>

<!-- Data Analysis Panel -->
<div id="analysis" class="panel">
<div class="card">
<h2>Expenditure Analysis</h2>
<label>Start Date:</label><input type="date" id="startDate">
<label>End Date:</label><input type="date" id="endDate">
<label>Select Site:</label><select id="siteSelect"><option value="">All Sites</option></select>
<button class="action" onclick="generateAnalysis()">Filter & Generate</button>
<button class="action" onclick="printPDF()">Print PDF</button>
<div id="analysisContent" class="scrollable-table"></div>
</div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxJJwXUv49yP8Q0Yx5ATxUN96BT_cHaKBiopcz7YySDtjMzetMORw63JKyHMqwZOAvrow/exec"; // replace with your deployed Apps Script URL

// Panel navigation
function showPanel(id){
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id === 'analysis') generateAnalysis();
}

// --- Personal Expenses ---
let personalExpenses = [];

function addPersonalExpense(){
  const desc = document.getElementById("personalDesc").value;
  const amt = parseFloat(document.getElementById("personalAmt").value);
  const date = document.getElementById("personalDate").value;
  const payment = document.getElementById("personalPayment").value;
  if(!desc || isNaN(amt) || !date){ alert("Fill all fields!"); return; }

  fetch(GAS_URL, {
    method: 'POST',
    body: JSON.stringify({ action:'savePersonal', desc, amt, date, payment }),
    headers: { 'Content-Type':'application/json' }
  }).then(res => res.json())
    .then(res => {
      fetchPersonalExpenses();
      document.getElementById("personalDesc").value = "";
      document.getElementById("personalAmt").value = "";
      document.getElementById("personalDate").value = "";
    });
}

function fetchPersonalExpenses(){
  fetch(GAS_URL+"?action=getPersonal")
    .then(res => res.json())
    .then(data => {
      personalExpenses = data;
      updatePersonalTable();
    });
}

function updatePersonalTable(){
  const table = document.getElementById("personalTable");
  table.innerHTML = "<tr><th>Category</th><th>Description</th><th>Amount</th><th>Date</th><th>Payment</th></tr>";
  personalExpenses.forEach(e => {
    table.innerHTML += `<tr>
      <td>${e.category}</td>
      <td>${e.desc}</td>
      <td>${e.amt}</td>
      <td>${e.date}</td>
      <td>${e.payment}</td>
    </tr>`;
  });
}

// --- Sites ---
let sites = {};

function addSite(){
  const name = document.getElementById("siteName").value.trim();
  if(!name || sites[name]){ alert("Enter new site or avoid duplicate!"); return; }

  fetch(GAS_URL, {
    method:'POST',
    body: JSON.stringify({ action:'addSite', site:name }),
    headers: { 'Content-Type':'application/json' }
  }).then(res=>res.json())
    .then(()=> fetchSites());

  document.getElementById("siteName").value = "";
}

function fetchSites(){
  fetch(GAS_URL+"?action=getSites")
    .then(res=>res.json())
    .then(data=>{
      sites = {};
      data.forEach(s => sites[s]=[]);
      updateSiteList();
    });
}

function updateSiteList(){
  const container = document.getElementById("siteList"); container.innerHTML="";
  const siteSelect = document.getElementById("siteSelect"); siteSelect.innerHTML='<option value="">All Sites</option>';
  const siteSelectManage = document.getElementById("siteSelectManage"); siteSelectManage.innerHTML='<option value="">--Select Site--</option>';
  for(let site in sites){
    let optionManage = document.createElement("option"); optionManage.value = site; optionManage.textContent = site; siteSelectManage.appendChild(optionManage);
    let optionAnalysis = document.createElement("option"); optionAnalysis.value = site; optionAnalysis.textContent = site; siteSelect.appendChild(optionAnalysis);
    let div = document.createElement("div"); div.classList.add("card"); div.innerHTML=`<h3>${site}</h3>`; container.appendChild(div);
  }
}

// Populate site fields when selected
function populateSiteFields(){
  const selected = document.getElementById("siteSelectManage").value;
  if(!selected){ document.getElementById("siteFields").style.display="none"; return; }
  document.getElementById("siteFields").style.display="block";
  fetchSiteExpenses(selected);
}

// Add site expense
function addSiteExpenseFromSelect(){
  const selected = document.getElementById("siteSelectManage").value;
  if(!selected){ alert("Select a site first!"); return; }
  const cat = document.getElementById("cat-selected").value;
  const desc = document.getElementById("desc-selected").value;
  const amt = parseFloat(document.getElementById("amt-selected").value);
  const date = document.getElementById("date-selected").value;
  const payment = document.getElementById("pay-selected").value;
  if(!desc || isNaN(amt) || !date){ alert("Fill all fields!"); return; }

  fetch(GAS_URL, {
    method:'POST',
    body: JSON.stringify({ action:'saveSite', site:selected, category:cat, desc, amt, date, payment }),
    headers: { 'Content-Type':'application/json' }
  }).then(res=>res.json())
    .then(()=> fetchSiteExpenses(selected));

  document.getElementById("desc-selected").value = "";
  document.getElementById("amt-selected").value = "";
  document.getElementById("date-selected").value = "";
}

// Fetch site expenses
function fetchSiteExpenses(site){
  fetch(GAS_URL+`?action=getSite&site=${encodeURIComponent(site)}`)
    .then(res=>res.json())
    .then(data => { sites[site]=data; updateSelectedSiteTable(site); });
}

function updateSelectedSiteTable(site){
  const table = document.getElementById("table-selected");
  table.innerHTML = "<tr><th>Category</th><th>Description</th><th>Amount</th><th>Date</th><th>Payment</th></tr>";
  sites[site].forEach(e => {
    table.innerHTML += `<tr>
      <td>${e.category}</td>
      <td>${e.desc}</td>
      <td>${e.amt}</td>
      <td>${e.date}</td>
      <td>${e.payment}</td>
    </tr>`;
  });
}

// --- Data Analysis ---
function generateAnalysis(){
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const selectedSite = document.getElementById("siteSelect").value;
  let html="<div class='summary'>";

  const filteredPersonal = personalExpenses.filter(e=>(!start||e.date>=start)&&(!end||e.date<=end));
  const totalPersonal = filteredPersonal.reduce((a,b)=>a+b.amt,0);
  html+=`<h3>Personal Expenditure (₹${totalPersonal})</h3>`;
  html+=`<div class="scrollable-table"><table><tr><th>Category</th><th>Description</th><th>Amount</th><th>Date</th><th>Payment</th></tr>`;
  filteredPersonal.forEach(e=>{ html+=`<tr><td>${e.category}</td><td>${e.desc}</td><td>${e.amt}</td><td>${e.date}</td><td>${e.payment}</td></tr>`; });
  html+="</table></div>";

  html+="<h3>Site-wise Expenditure</h3>";
  let totalSite=0;
  for(let site in sites){
    if(selectedSite && site!==selectedSite) continue;
    const filtered=sites[site].filter(e=>(!start||e.date>=start)&&(!end||e.date<=end));
    if(filtered.length===0) continue;
    const siteTotal = filtered.reduce((a,b)=>a+b.amt,0);
    totalSite+=siteTotal;
    html+=`<h4>${site} (₹${siteTotal})</h4>`;
    html+=`<div class="scrollable-table"><table><tr><th>Category</th><th>Description</th><th>Amount</th><th>Date</th><th>Payment</th></tr>`;
    filtered.forEach(e=>{ html+=`<tr><td>${e.category}</td><td>${e.desc}</td><td>${e.amt}</td><td>${e.date}</td><td>${e.payment}</td></tr>`; });
    html+="</table></div>";
  }

  html+=`<h3>Total Expenditure: ₹${totalPersonal + totalSite}</h3></div>`;
  document.getElementById("analysisContent").innerHTML = html;
}

// --- PDF Generation ---
function printPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16); doc.text("M/s. Buyite Electricals - Expenditure Report", 14, 20);
  doc.setFontSize(12); doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 28);
  
  const tables = document.querySelectorAll("#analysisContent table"); let y=35;
  tables.forEach(tbl=>{
    doc.autoTable({ html: tbl, startY: y, theme:'grid', headStyles:{fillColor:[85,89,92]} });
    y = doc.lastAutoTable.finalY + 10;
  });
  doc.save('Expenditure_Report.pdf');
}

// --- Initialize ---
fetchPersonalExpenses();
fetchSites();
</script>


</body>
</html>


